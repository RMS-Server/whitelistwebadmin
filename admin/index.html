<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RMS白名单管理系统 - 管理员</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/style.css?v=1.02" rel="stylesheet">
    <style>
        .container { margin-top: 50px; }
        .table-responsive { margin-top: 20px; }
        .alert { display: none; }
        .copyright {
            text-align: center;
            margin: 30px 0;
            color: #fff;
            font-size: 16px;
        }
        .card-header {
            position: relative;
            padding: 1rem 1.25rem;
        }
        .card-header h2 {
            margin: 0;
            display: inline-block;
            font-size: 1.5rem;
        }
        .card-header .btn {
            position: absolute;
            right: 1.25rem;
            top: 50%;
            transform: translateY(-50%);
        }
        #loginForm {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            max-width: 500px;
            padding: 2rem;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        #loginForm .main-title {
            color: #4CAF50;
            margin-bottom: 1.5rem;
            font-size: 2.5rem;
            font-weight: bold;
        }
        #loginForm h2 {
            color: #333;
            margin-bottom: 2rem;
        }
        #loginForm .form-control {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 0.8rem;
        }
        #loginForm .btn-primary {
            background-color: #4CAF50;
            border: none;
            padding: 0.8rem 2rem;
            font-size: 1.1rem;
            margin-top: 1rem;
        }
        #loginForm .btn-primary:hover {
            background-color: #45a049;
        }
        body {
            min-height: 100vh;
            margin: 0;
            position: relative;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 登录表单 -->
        <div id="loginForm" class="col-md-6 mx-auto">
            <h1 class="text-center main-title">RMS白名单管理系统</h1>
            <h2 class="text-center mb-4">管理员登录</h2>
            <form id="adminLoginForm">
                <div class="mb-3">
                    <label for="password" class="form-label">管理员口令</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <div class="text-center">
                    <button type="submit" class="btn btn-primary">登录</button>
                </div>
                <div class="alert alert-danger mt-3" id="loginError" style="display: none;"></div>
            </form>
        </div>

        <!-- 主要内容 -->
        <div id="mainContent" style="display: none;">
            <h1 class="text-center main-title">RMS白名单管理系统 - 管理员</h1>
            
            <!-- 提示消息 -->
            <div class="alert alert-success" id="successAlert"></div>
            <div class="alert alert-danger" id="errorAlert"></div>
            
            <!-- 系统更新 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h2>系统更新</h2>
                    <button class="btn btn-sm btn-primary" onclick="checkForUpdates()">检查更新</button>
                </div>
                <div class="card-body">
                    <div id="updateStatus">
                        <p class="text-muted">点击"检查更新"来查看是否有新版本可用</p>
                    </div>
                    <div id="updateActions" style="display: none;">
                        <button class="btn btn-success" onclick="performUpdate()" id="updateBtn">立即更新</button>
                        <button class="btn btn-secondary ms-2" onclick="hideUpdateActions()">取消</button>
                    </div>
                    <div id="updateProgress" style="display: none;">
                        <div class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 100%"></div>
                        </div>
                        <p class="text-info">正在从国内镜像下载更新，请稍候...</p>
                        <small class="text-muted">系统会自动尝试多个镜像以确保下载成功</small>
                    </div>
                </div>
            </div>
            
            <!-- 临时登录请求 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h2>临时登录请求</h2>
                    <button class="btn btn-sm btn-primary" onclick="refreshTempRequests()">刷新</button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>玩家名称</th>
                                    <th>请求时间</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="tempRequestsTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 改名提示卡片 -->
            <div class="mb-4 p-3" style="border: 1px solid #FF9800; border-radius: 10px; background-color: rgba(255, 243, 224, 0.8); backdrop-filter: blur(5px); transition: transform 0.3s, box-shadow 0.3s;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 20px rgba(0,0,0,0.1)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                <p class="mb-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#FF9800" class="bi bi-exclamation-triangle-fill me-2" viewBox="0 0 16 16">
                        <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                    </svg>
                    <strong>提示：</strong>玩家改名需要重新添加白名单的，请记得删除之前的ID
                </p>
            </div>

            <!-- 待处理申请 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h2>待处理申请</h2>
                    <button class="btn btn-sm btn-primary" onclick="refreshApplications()">刷新</button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>玩家名称</th>
                                    <th>申请时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="applicationsTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 白名单列表 -->
            <div class="card">
                <div class="card-header">
                    <h2>白名单列表</h2>
                    <button class="btn btn-sm btn-primary" onclick="refreshList()">刷新</button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>玩家名称</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="whitelistTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 版权信息 -->
            <div class="copyright">
                2024 RMS Server. All Rights Reserved.
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let adminToken = '';

        // 显示提示消息
        function showAlert(message, isError = false) {
            const alertElement = isError ? document.getElementById('errorAlert') : document.getElementById('successAlert');
            alertElement.textContent = message;
            alertElement.style.display = 'block';
            setTimeout(() => {
                alertElement.style.display = 'none';
            }, 3000);
        }

        // 处理登录
        document.getElementById('adminLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('loginError');
            
            try {
                const response = await fetch('../api/admin-login.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ password }),
                });
                
                const data = await response.json();
                if (data.success) {
                    adminToken = data.data.token;
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    refreshList();
                    refreshApplications();
                    loginError.style.display = 'none';
                } else {
                    loginError.textContent = data.message;
                    loginError.style.display = 'block';
                    document.getElementById('password').value = '';
                }
            } catch (error) {
                loginError.textContent = '登录失败，请稍后重试';
                loginError.style.display = 'block';
            }
        });

        // 刷新白名单列表
        async function refreshList() {
            if (!adminToken) return;
            
            try {
                const response = await fetch('../api/list.php', {
                    headers: {
                        'Authorization': adminToken
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    const tbody = document.getElementById('whitelistTable');
                    tbody.innerHTML = '';
                    
                    data.data.forEach((item, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${item.index}</td>
                            <td>${item.username}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="removeWhitelist(${item.id}, '${item.username}')">
                                    删除
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    showAlert(data.message, true);
                }
            } catch (error) {
                showAlert('获取白名单列表失败', true);
            }
        }

        // 刷新申请列表
        async function refreshApplications() {
            if (!adminToken) return;
            
            try {
                const response = await fetch('../api/pending-applications.php', {
                    headers: {
                        'Authorization': adminToken
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    const tbody = document.getElementById('applicationsTable');
                    tbody.innerHTML = '';
                    
                    data.data.forEach((item, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${item.username}</td>
                            <td>${item.created_at}</td>
                            <td>
                                <button class="btn btn-sm btn-success me-2" onclick="handleApplication(${item.id}, true)">
                                    同意
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="handleApplication(${item.id}, false)">
                                    拒绝
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    showAlert(data.message, true);
                }
            } catch (error) {
                showAlert('获取申请列表失败', true);
            }
        }

        // 处理申请
        async function handleApplication(id, approve) {
            if (!adminToken) return;
            
            try {
                const response = await fetch('../api/handle-application.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': adminToken
                    },
                    body: JSON.stringify({ id, approve }),
                });
                
                const data = await response.json();
                showAlert(data.message, !data.success);
                
                if (data.success) {
                    refreshApplications();
                    refreshList();
                }
            } catch (error) {
                showAlert('处理申请失败', true);
            }
        }

        // 删除白名单
        async function removeWhitelist(id, username) {
            if (!adminToken) return;
            
            if (!confirm(`确定要删除玩家 ${username} 的白名单吗？`)) {
                return;
            }
            
            try {
                const response = await fetch('../api/remove.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': adminToken
                    },
                    body: JSON.stringify({ id: id }),
                });
                
                const data = await response.json();
                showAlert(data.message, !data.success);
                
                if (data.success) {
                    refreshList();
                }
            } catch (error) {
                showAlert('删除白名单失败', true);
            }
        }
        // 刷新临时登录请求列表
        async function refreshTempRequests() {
            if (!adminToken) return;
            
            try {
                const response = await fetch('../api/temp-requests.php', {
                    headers: {
                        'Authorization': adminToken
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    const tbody = document.getElementById('tempRequestsTable');
                    tbody.innerHTML = '';
                    
                    data.data.forEach((item, index) => {
                        const row = document.createElement('tr');
                        const statusBadge = getStatusBadge(item.status);
                        const actions = item.status === 'pending' ? `
                            <button class="btn btn-sm btn-success me-2" onclick="handleTempRequest(${item.id}, 'approved')">
                                同意
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="handleTempRequest(${item.id}, 'rejected')">
                                拒绝
                            </button>
                        ` : '';
                        
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${item.username}</td>
                            <td>${item.request_time}</td>
                            <td>${statusBadge}</td>
                            <td>${actions}</td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    showAlert(data.message, true);
                }
            } catch (error) {
                showAlert('获取临时登录请求失败', true);
            }
        }
        
        // 处理临时登录请求
        async function handleTempRequest(id, status) {
            if (!adminToken) return;
            
            try {
                const response = await fetch('../api/handle-temp-request.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': adminToken
                    },
                    body: JSON.stringify({ id, status }),
                });
                
                const data = await response.json();
                showAlert(data.message, !data.success);
                
                if (data.success) {
                    refreshTempRequests();
                }
            } catch (error) {
                showAlert('处理临时登录请求失败', true);
            }
        }
        
        // 获取状态标签
        function getStatusBadge(status) {
            const badges = {
                'pending': '<span class="badge bg-warning">等待中</span>',
                'approved': '<span class="badge bg-success">已批准</span>',
                'rejected': '<span class="badge bg-danger">已拒绝</span>',
                'timeout': '<span class="badge bg-secondary">已超时</span>'
            };
            return badges[status] || status;
        }

        // 检查更新
        async function checkForUpdates() {
            if (!adminToken) return;
            
            const updateStatus = document.getElementById('updateStatus');
            const updateActions = document.getElementById('updateActions');
            
            updateStatus.innerHTML = '<p class="text-info">正在检查更新...</p>';
            updateActions.style.display = 'none';
            
            try {
                const response = await fetch('../api/update.php?action=check', {
                    headers: {
                        'Authorization': adminToken
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    if (data.data.need_update) {
                        updateStatus.innerHTML = `
                            <div class="alert alert-warning">
                                <strong>发现新版本！</strong><br>
                                当前版本: ${data.data.current_version}<br>
                                最新版本: ${data.data.remote_version}
                            </div>
                        `;
                        updateActions.style.display = 'block';
                    } else {
                        updateStatus.innerHTML = `
                            <div class="alert alert-success">
                                <strong>已是最新版本</strong><br>
                                当前版本: ${data.data.current_version}
                            </div>
                        `;
                    }
                } else {
                    updateStatus.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                }
            } catch (error) {
                updateStatus.innerHTML = '<div class="alert alert-danger">检查更新失败，请稍后重试</div>';
            }
        }
        
        // 执行更新
        async function performUpdate() {
            if (!adminToken) return;
            
            if (!confirm('确定要执行更新吗？更新过程中请不要关闭页面。')) {
                return;
            }
            
            const updateStatus = document.getElementById('updateStatus');
            const updateActions = document.getElementById('updateActions');
            const updateProgress = document.getElementById('updateProgress');
            const updateBtn = document.getElementById('updateBtn');
            
            updateActions.style.display = 'none';
            updateProgress.style.display = 'block';
            updateBtn.disabled = true;
            
            try {
                const response = await fetch('../api/update.php?action=update', {
                    headers: {
                        'Authorization': adminToken
                    }
                });
                const data = await response.json();
                
                updateProgress.style.display = 'none';
                
                if (data.success) {
                    updateStatus.innerHTML = `
                        <div class="alert alert-success">
                            <strong>更新成功！</strong><br>
                            ${data.data.old_version} → ${data.data.new_version}<br>
                            <small>页面将在3秒后自动刷新</small>
                        </div>
                    `;
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                } else {
                    updateStatus.innerHTML = `<div class="alert alert-danger">更新失败: ${data.message}</div>`;
                    updateBtn.disabled = false;
                }
            } catch (error) {
                updateProgress.style.display = 'none';
                updateStatus.innerHTML = '<div class="alert alert-danger">更新失败，请稍后重试</div>';
                updateBtn.disabled = false;
            }
        }
        
        // 隐藏更新操作
        function hideUpdateActions() {
            document.getElementById('updateActions').style.display = 'none';
        }

        // 页面加载完成后刷新所有列表
        document.addEventListener('DOMContentLoaded', () => {
            if (adminToken) {
                refreshList();
                refreshApplications();
                refreshTempRequests();
            }
        });
    </script>
</body>
</html>

